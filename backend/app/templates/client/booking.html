<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inter-Paws Appointment Booking</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: #f6f8fb;
        color: #1f2933;
      }

      .page {
        max-width: 960px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
      }

      h1 {
        margin-bottom: 0.25rem;
        font-size: clamp(1.8rem, 2.5vw, 2.5rem);
      }

      p.lead {
        margin-top: 0;
        color: #52606d;
      }

      form {
        display: grid;
        gap: 1.25rem;
        background: #ffffff;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 24px 48px rgba(15, 23, 42, 0.08);
      }

      fieldset {
        border: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1rem;
      }

      .grid {
        display: grid;
        gap: 1rem;
      }

      @media (min-width: 720px) {
        .grid.two-column {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      label {
        font-weight: 600;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      input[type="text"],
      input[type="email"],
      input[type="date"],
      input[type="datetime-local"],
      select,
      textarea {
        padding: 0.65rem 0.75rem;
        border-radius: 10px;
        border: 1px solid #d2dae2;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        background: rgba(255, 255, 255, 0.9);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3f83f8;
        box-shadow: 0 0 0 4px rgba(63, 131, 248, 0.15);
      }

      textarea {
        resize: vertical;
        min-height: 96px;
      }

      button {
        justify-self: start;
        background: linear-gradient(135deg, #3f83f8, #0052cc);
        border: none;
        color: #ffffff;
        font-weight: 600;
        padding: 0.85rem 1.75rem;
        border-radius: 999px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 32px rgba(15, 23, 42, 0.18);
      }

      button:disabled {
        cursor: not-allowed;
        background: #94a3b8;
        box-shadow: none;
        transform: none;
      }

      .results {
        margin-top: 2.5rem;
        display: grid;
        gap: 1rem;
      }

      .result-card {
        border-radius: 12px;
        border: 1px solid #d2dae2;
        padding: 1.25rem;
        background: #ffffff;
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.08);
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 0.5rem;
      }

      .result-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }

      .score {
        font-size: 0.95rem;
        color: #52606d;
      }

      .hidden {
        display: none !important;
      }

      .error {
        padding: 1rem;
        border-radius: 10px;
        background: rgba(255, 67, 67, 0.1);
        color: #b42318;
        border: 1px solid rgba(255, 67, 67, 0.25);
      }

      .success {
        padding: 1rem;
        border-radius: 10px;
        background: rgba(34, 197, 94, 0.12);
        color: #047857;
        border: 1px solid rgba(16, 185, 129, 0.3);
      }

      .disclaimer {
        padding: 1rem;
        border-radius: 10px;
        background: rgba(255, 186, 0, 0.12);
        color: #8a5300;
        border: 1px solid rgba(255, 186, 0, 0.35);
      }
    </style>
  </head>
  <body>
    <div class="page">
      <h1>Book an Appointment</h1>
      <p class="lead">
        Tell us about your pet's needs and we'll suggest the best available slots at
        your clinic.
      </p>
      <div class="disclaimer">
        If this is an emergency, please call us directly or come to the clinic
        immediately. Do not use this form for urgent medical needs.
      </div>

      <form id="booking-form">
        <input type="hidden" name="clinic_id" value="1" />
        <input type="hidden" name="duration_minutes" value="30" />
        <input type="hidden" name="granularity_minutes" value="15" />

        <fieldset class="grid two-column">
          <label>
            Pet's Name
            <input
              type="text"
              name="pet_name"
              required
              placeholder="e.g. Luna"
            />
          </label>
          <label>
            Your Name
            <input
              type="text"
              name="owner_name"
              required
              placeholder="e.g. Alex Johnson"
            />
          </label>
          <label>
            Your Email
            <input
              type="email"
              name="owner_email"
              required
              placeholder="you@example.com"
            />
          </label>
        </fieldset>

        <fieldset class="grid two-column">
          <label>
            Preferred Date
            <input type="date" name="preferred_date" required />
          </label>
          <label>
            Preferred Time
            <select name="preferred_time">
              <option value="any" selected>Any Time</option>
              <option value="morning">Morning (8am-12pm)</option>
              <option value="afternoon">Afternoon (12pm-5pm)</option>
            </select>
          </label>
        </fieldset>

        <fieldset>
          <label>
            Reason for visit
            <textarea name="reason_for_visit" placeholder="Tell us what's going on"></textarea>
          </label>
        </fieldset>

        <fieldset class="grid two-column">
          <label>
            Urgency
            <select name="urgency">
              <option value="Routine" selected>Routine</option>
              <option value="Urgent">Urgent</option>
            </select>
          </label>
        </fieldset>

        <button type="submit">Find Appointment Options</button>
        <div id="form-error" class="error hidden"></div>
        <div id="booking-success" class="success hidden"></div>
      </form>

      <section class="results hidden" id="results-section">
        <h2>Recommended appointment slots</h2>
        <div id="results-container"></div>
      </section>

      <div style="margin-top: 2rem">
        <a href="/onboarding">Switch to Clinic Onboarding (Dev Link)</a>
      </div>
    </div>

    <script>
      const form = document.getElementById("booking-form");
      const errorBox = document.getElementById("form-error");
      const resultsSection = document.getElementById("results-section");
      const resultsContainer = document.getElementById("results-container");
      const successBox = document.getElementById("booking-success");

      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toLocaleString([], {
          dateStyle: "medium",
          timeStyle: "short",
        });
      }

      function showError(message) {
        errorBox.textContent = message;
        errorBox.classList.remove("hidden");
      }

      function hideError() {
        errorBox.textContent = "";
        errorBox.classList.add("hidden");
      }

      function showSuccess(message) {
        successBox.textContent = message;
        successBox.classList.remove("hidden");
      }

      function hideSuccess() {
        successBox.textContent = "";
        successBox.classList.add("hidden");
      }

      function resetResults() {
        resultsContainer.innerHTML = "";
        resultsSection.classList.add("hidden");
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        hideError();
        hideSuccess();
        resetResults();

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());

        const preferredDate = payload.preferred_date;

        if (!preferredDate) {
          showError("Please select a preferred date.");
          return;
        }

        const preferredTime = payload.preferred_time;

        if (preferredTime === "morning") {
          payload.start = `${preferredDate}T08:00:00`;
          payload.end = `${preferredDate}T12:00:00`;
        } else if (preferredTime === "afternoon") {
          payload.start = `${preferredDate}T12:00:00`;
          payload.end = `${preferredDate}T17:00:00`;
        } else {
          payload.start = `${preferredDate}T00:00:00`;
          payload.end = `${preferredDate}T23:59:59`;
        }
        payload.duration_minutes = Number(payload.duration_minutes || 30);
        payload.granularity_minutes = Number(payload.granularity_minutes || 15);
        payload.clinic_id = Number(payload.clinic_id);
        payload.owner_name = payload.owner_name?.trim() || "";
        payload.owner_email = payload.owner_email?.trim() || "";
        payload.pet_name = payload.pet_name?.trim() || "";

        if (Number.isNaN(payload.clinic_id)) {
          showError("Clinic ID must be a valid number.");
          return;
        }

        if (!payload.owner_name || !payload.owner_email || !payload.pet_name) {
          showError("Please provide your name, email, and your pet's name.");
          return;
        }

        const submitButton = form.querySelector("button[type='submit']");
        submitButton.disabled = true;
        submitButton.textContent = "Finding slots...";

        try {
          const response = await fetch("/api/schedule/find-slots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const body = await response.json();

          if (!response.ok) {
            throw new Error(body.message || "Unable to fetch appointment slots.");
          }

          const suggestions = body.suggestions || [];

          if (suggestions.length === 0) {
            showError("No appointment slots were available for the selected window.");
            return;
          }

          resultsSection.classList.remove("hidden");
          resultsContainer.innerHTML = "";
          suggestions.forEach((slot) => {
            const doctorLabel = slot.doctor_id ? `Dr. #${slot.doctor_id}` : "Any doctor";
            const roomLabel = slot.room_id ? `Room #${slot.room_id}` : "Any room";
            const scoreLabel =
              slot.score != null ? `${(slot.score * 100).toFixed(0)}% fit` : "Ranked option";
            const card = document.createElement("article");
            card.className = "result-card";
            card.innerHTML = `
                  <div class="result-header">
                    <h3>Option ${slot.rank}</h3>
                    <span class="score">${scoreLabel}</span>
                  </div>
                  <p><strong>${doctorLabel}</strong> in <strong>${roomLabel}</strong></p>
                  <p>${formatDate(slot.start_time)} â€“ ${formatDate(slot.end_time)}</p>
                  <p>${slot.rationale || "Recommended based on clinic availability."}</p>
                  <button type="button" class="book-button">Book This Slot</button>
            `;
            const bookButton = card.querySelector(".book-button");
            bookButton.dataset.slot = JSON.stringify(slot);
            resultsContainer.appendChild(card);
          });
        } catch (error) {
          console.error(error);
          showError(error.message || "An unexpected error occurred.");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = "Find Appointment Options";
        }
      });

      resultsContainer.addEventListener("click", async (event) => {
        const button = event.target.closest(".book-button");
        if (!button) {
          return;
        }

        event.preventDefault();
        hideError();
        hideSuccess();

        let slot;
        try {
          slot = JSON.parse(button.dataset.slot || "{}");
        } catch (parseError) {
          console.error(parseError);
          showError("Unable to read the selected slot details.");
          return;
        }

        const clinicIdValue = form.elements.clinic_id.value;
        const ownerName = form.elements.owner_name.value.trim();
        const ownerEmail = form.elements.owner_email.value.trim();
        const petName = form.elements.pet_name.value.trim();
        const reasonValue = form.elements.reason_for_visit.value || "";

        const clinicId = Number(clinicIdValue);

        if (Number.isNaN(clinicId)) {
          showError("Clinic ID must be a valid number.");
          return;
        }

        if (!ownerName || !ownerEmail || !petName) {
          showError("Please provide your name, email, and your pet's name.");
          return;
        }

        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = "Booking...";

        const bookingPayload = {
          clinic_id: clinicId,
          owner_name: ownerName,
          owner_email: ownerEmail,
          pet_name: petName,
          reason: reasonValue.trim() || null,
          suggestion: slot,
        };

        try {
          const response = await fetch("/api/schedule/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bookingPayload),
          });

          const body = await response.json();

          if (!response.ok) {
            throw new Error(body.message || "Unable to book appointment.");
          }

          showSuccess(body.message || "Appointment booked successfully!");
          resetResults();
        } catch (error) {
          console.error(error);
          showError(error.message || "An unexpected error occurred while booking.");
        } finally {
          if (resultsContainer.contains(button)) {
            button.disabled = false;
            button.textContent = originalText;
          }
        }
      });
    </script>
  </body>
</html>
